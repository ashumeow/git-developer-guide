
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Packaging Third-Party Code &mdash; Sage Developer&#39;s Guide v1.0</title>
    
    <link rel="stylesheet" href="_static/sage.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="top" title="Sage Developer&#39;s Guide v1.0" href="index.html" />
    <link rel="next" title="Packaging Old-Style SPKGs" href="packaging_old_spkgs.html" />
    <link rel="prev" title="Using External Libraries and Interfaces" href="coding_in_other.html" />
    <link rel="icon" href="_static/sageicon.png" type="image/x-icon" />

  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="packaging_old_spkgs.html" title="Packaging Old-Style SPKGs"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="coding_in_other.html" title="Using External Libraries and Interfaces"
             accesskey="P">previous</a> |</li>
  
    
      <a href="../index.html"><img src="_static/sagelogo.png" style="vertical-align: middle" title="Sage Logo"></a>
    
  
  
        <li><a href="index.html">Developer&#39;s Guide v1.0</a> &raquo;</li>
 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="packaging-third-party-code">
<span id="chapter-packaging"></span><h1>Packaging Third-Party Code<a class="headerlink" href="#packaging-third-party-code" title="Permalink to this headline">¶</a></h1>
<p>One of the mottoes of the Sage project is to not reinvent the
wheel: If an algorithm is already implemented in a well-tested library
then consider incorporating that library into Sage. The current list
of available packages are the subdirectories of
<tt class="docutils literal"><span class="pre">SAGE_ROOT/build/pkgs/</span></tt>.</p>
<p>Not all of these packages are built by default, they are divided into
standard and optional ones. Standard packages are built by default and
have much more stringent quality requirements. In addition, there are
experimental spkgs (and some legacy optional spkgs) that are just
tarballs containing build scripts.</p>
<div class="section" id="inclusion-procedure-for-new-packages">
<h2>Inclusion Procedure for New Packages<a class="headerlink" href="#inclusion-procedure-for-new-packages" title="Permalink to this headline">¶</a></h2>
<p>For a package to become part of Sage&#8217;s standard distribution, it
must meet the following requirements:</p>
<ul>
<li><p class="first"><strong>License</strong>. For standard packages, the license must be compatible
with the GNU General Public License, version 3. The Free Software
Foundation maintains a long list of <a class="reference external" href="http://www.gnu.org/licenses/license-list.html">licenses and comments about
them</a>.</p>
</li>
<li><p class="first"><strong>Build Support</strong>. The code must build on all the <a class="reference external" href="http://wiki.sagemath.org/SupportedPlatforms#Fully_supported">fully supported
platforms</a>.</p>
<p>A standard package should also work on all the platforms where Sage
is <a class="reference external" href="http://wiki.sagemath.org/SupportedPlatforms#Expected_to_work">expected to work</a> and
on which Sage <a class="reference external" href="http://wiki.sagemath.org/SupportedPlatforms#Almost_works">almost works</a> but
since we don&#8217;t fully support these platforms and often lack the
resources to test on them, you are not expected to confirm your
packages works on those platforms.</p>
</li>
<li><p class="first"><strong>Quality</strong>. The code should be &#8220;better&#8221; than any other available
code (that passes the two above criteria), and the authors need to
justify this. The comparison should be made to both Python and other
software. Criteria in passing the quality test include:</p>
<ul class="simple">
<li>Speed</li>
<li>Documentation</li>
<li>Usability</li>
<li>Absence of memory leaks</li>
<li>Maintainable</li>
<li>Portability</li>
<li>Reasonable build time, size, dependencies</li>
</ul>
</li>
<li><p class="first"><strong>Previously an optional package</strong>. A new standard package must have
spent some time as an optional package. Or have a good reason why
this is not possible.</p>
</li>
<li><p class="first"><strong>Refereeing</strong>. The code must be refereed, as discussed in
<a class="reference internal" href="trac.html#chapter-sage-trac"><em>The Sage Trac Server</em></a>.</p>
</li>
</ul>
</div>
<div class="section" id="directory-structure">
<span id="section-directory-structure"></span><h2>Directory Structure<a class="headerlink" href="#directory-structure" title="Permalink to this headline">¶</a></h2>
<p>Third-party packages in Sage consists of two parts:</p>
<ol class="arabic simple">
<li>The tarball as it is distributed by the third party, or as close as
possible. Valid reasons for modifying the tarball are deleting
unnecessary files to keeep the download size manageable or
regenerating auto-generated files if necessary. But the actual code
must be unmodified. See also <a class="reference internal" href="#section-spkg-src"><em>Modified Tarballs</em></a>.</li>
<li>The build scripts and associated files are in a subdirectory
<tt class="docutils literal"><span class="pre">SAGE_ROOT/build/pkgs/package</span></tt>, where you replace <tt class="docutils literal"><span class="pre">package</span></tt>
with a lower-case version of the upstream project name.</li>
</ol>
<p>As an example, let us consider a hypothetical FoO project. They
(upstream) distribute a tarball <tt class="docutils literal"><span class="pre">foo-1.3.tar.gz</span></tt>. to package it in
Sage, we create a subdirectory containing the following:</p>
<div class="highlight-python"><pre>SAGE_ROOT/build/pkgs/foo
|-- patches
|   |-- bar.patch
|   `-- baz.patch
|-- checksums.ini
|-- package-version.txt
|-- spkg-check
|-- spkg-install
|-- spkg-src
`-- SPKG.txt</pre>
</div>
<p>We discuss the individual files in the following.</p>
<div class="section" id="install-script">
<span id="section-spkg-install"></span><h3>Install Script<a class="headerlink" href="#install-script" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">spkg-install</span></tt> file is a shell script installing the package,
with <tt class="docutils literal"><span class="pre">PACKAGE_NAME</span></tt> replaced by the the package name. In the best
case, the upstream project can simply be installed by the usual
configure / make / make install steps. In that case, the build script
would simply consist of:</p>
<div class="highlight-python"><pre>#!/usr/bin/env bash

cd src

./configure --prefix="$SAGE_LOCAL" --libdir="$SAGE_LOCAL/lib"
if [ $? -ne 0 ]; then
    echo &gt;&amp;2 "Error configuring PACKAGE_NAME."
    exit 1
fi

$MAKE
if [ $? -ne 0 ]; then
    echo &gt;&amp;2 "Error building PACKAGE_NAME."
    exit 1
fi

$MAKE -j1 install
if [ $? -ne 0 ]; then
    echo &gt;&amp;2 "Error installing PACKAGE_NAME."
    exit 1
fi</pre>
</div>
<p>Note that the top-level directory inside the tarball is renamed to
<tt class="docutils literal"><span class="pre">src</span></tt> before calling the <tt class="docutils literal"><span class="pre">spkg-install</span></tt> script, so you can just
use <tt class="docutils literal"><span class="pre">cd</span> <span class="pre">src</span></tt> instead of <tt class="docutils literal"><span class="pre">cd</span> <span class="pre">foo-1.3</span></tt>.</p>
<p>If there is any meaningful documentation included but not installed by
<tt class="docutils literal"><span class="pre">make</span> <span class="pre">install</span></tt>, then you can add something like the following to
install it:</p>
<div class="highlight-python"><pre>if [ "$SAGE_SPKG_INSTALL_DOCS" = yes ] ; then
    $MAKE doc
    if [ $? -ne 0 ]; then
        echo &gt;&amp;2 "Error building PACKAGE_NAME docs."
        exit 1
    fi
    mkdir -p "$SAGE_LOCAL/share/doc/PACKAGE_NAME"
    cp -R doc/* "$SAGE_ROOT/local/share/doc/PACKAGE_NAME"
fi</pre>
</div>
</div>
<div class="section" id="self-tests">
<span id="section-spkg-check"></span><h3>Self-Tests<a class="headerlink" href="#self-tests" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">spkg-check</span></tt> file is an optional, but highly recommended, script
to run self-tests of the package. It is run after building and
installing if the <tt class="docutils literal"><span class="pre">SAGE_CHECK</span></tt> environment variable is set, see the
Sage installation guide. Ideally, upstream has some sort of tests
suite that can be run with the standard <tt class="docutils literal"><span class="pre">make</span> <span class="pre">check</span></tt> target. In that
case, the <tt class="docutils literal"><span class="pre">spkg-check</span></tt> script would simply contain:</p>
<div class="highlight-python"><pre>#!/usr/bin/env bash

cd src
$MAKE check</pre>
</div>
</div>
<div class="section" id="package-versioning">
<span id="section-spkg-versioning"></span><h3>Package Versioning<a class="headerlink" href="#package-versioning" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">package-version.txt</span></tt> file containts just the version. So if
upstream is <tt class="docutils literal"><span class="pre">foo-1.3.tar.gz</span></tt> then the package version file would
only contain <tt class="docutils literal"><span class="pre">1.3</span></tt>.</p>
<p>If the upstream package is taken from some revision other than a
stable version, you should use the date at which the revision is made,
e.g. the Singular package <tt class="docutils literal"><span class="pre">20090818</span></tt> is made with the revision as of
2009-08-18.</p>
<p>If you made any changes to the upstream tarball (see
<a class="reference internal" href="#section-directory-structure"><em>Directory Structure</em></a> for allowable changes) then you
should append a <tt class="docutils literal"><span class="pre">.p1</span></tt> to the version. If you make further changes,
increase the patch level as necessary. So the different versions would
be <tt class="docutils literal"><span class="pre">1.3</span></tt>, <tt class="docutils literal"><span class="pre">1.3.p1</span></tt>, <tt class="docutils literal"><span class="pre">1.3.p2</span></tt>, ...</p>
</div>
<div class="section" id="the-spkg-txt-file">
<span id="section-spkg-spkg-txt"></span><h3>The SPKG.txt File<a class="headerlink" href="#the-spkg-txt-file" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">SPKG.txt</span></tt> file should follow this pattern:</p>
<div class="highlight-python"><pre>= PACKAGE_NAME =

== Description ==

What does the package do?

== License ==

What is the license? If non-standard, is it GPLv3+ compatible?

== SPKG Maintainers ==

* Mary Smith
* Bill Jones
* Leonhard Euler

== Upstream Contact ==

Provide information for upstream contact.

== Dependencies ==

Put a bulleted list of dependencies here:

* python
* readline

== Special Update/Build Instructions ==

List patches that need to be applied and what they do. If the
tarball was modified by hand and not via a spkg-src script,
describe what was changed.</pre>
</div>
<p>with <tt class="docutils literal"><span class="pre">PACKAGE_NAME</span></tt> replaced by the the package name. Legacy
<tt class="docutils literal"><span class="pre">SPKG.txt</span></tt> files have an additional changelog section, but this
information is now kept in the git repository.</p>
</div>
<div class="section" id="patching-sources">
<span id="section-spkg-patching"></span><h3>Patching Sources<a class="headerlink" href="#patching-sources" title="Permalink to this headline">¶</a></h3>
<p>Actual changes to the source code must be via patches, which should be
placed in the <tt class="docutils literal"><span class="pre">patches</span></tt> directory. GNU patch is distributed with
Sage, so you can rely on it being available. All patches must be
documented in <tt class="docutils literal"><span class="pre">SPKG.txt</span></tt>, i.e. what they do, if they are platform
specific, if they should be pushed upstream, etc.</p>
<p>Patches to files in <tt class="docutils literal"><span class="pre">src/</span></tt> need to be applied in <tt class="docutils literal"><span class="pre">spkg-install</span></tt>,
that is, if there are any patches then your <tt class="docutils literal"><span class="pre">spkg-install</span></tt> script
should contain a section like this:</p>
<div class="highlight-python"><pre>for patch in ../patches/*.patch; do
    [ -r "$patch" ] || continue  # Skip non-existing or non-readable patches
    patch -p1 &lt;"$patch"
    if [ $? -ne 0 ]; then
        echo &gt;&amp;2 "Error applying '$patch'"
        exit 1
    fi
done</pre>
</div>
<p>which applies the patches to the sources.</p>
</div>
<div class="section" id="modified-tarballs">
<span id="section-spkg-src"></span><h3>Modified Tarballs<a class="headerlink" href="#modified-tarballs" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">spkg-src</span></tt> file is optional and only to document how the
upstream tarball was changed. Ideally it is not modified, then there
would be no <tt class="docutils literal"><span class="pre">spkg-src</span></tt> file present either.</p>
<p>However, if you really must modify the upstream tarball then it is
recommended that you write a script, called <tt class="docutils literal"><span class="pre">spkg-src</span></tt>, that makes
the changes. This not only serves as documentation but also makes it
easier to apply the same modifications to future versions.</p>
</div>
<div class="section" id="checksums">
<h3>Checksums<a class="headerlink" href="#checksums" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">checksums.ini</span></tt> file contains checksums of the upstream
tarball. It is autogenerated, so you just have to place the upstream
tarball in the <tt class="docutils literal"><span class="pre">SAGE_ROOT/upstream/</span></tt> directory and run:</p>
<div class="highlight-python"><pre>[user@localhost]$ sage -sh sage-fix-pkg-checksums</pre>
</div>
</div>
</div>
<div class="section" id="testing">
<h2>Testing<a class="headerlink" href="#testing" title="Permalink to this headline">¶</a></h2>
<p>If you have a new tarball that is not yet distributed with Sage, then
you have to manually place it in the <tt class="docutils literal"><span class="pre">SAGE_ROOT/upstream/`</span>
<span class="pre">directory.</span> <span class="pre">Then</span> <span class="pre">you</span> <span class="pre">can</span> <span class="pre">run</span> <span class="pre">the</span> <span class="pre">istallation</span> <span class="pre">via</span> <span class="pre">``sage</span> <span class="pre">-f</span>
<span class="pre">package_name</span></tt>. If your package contains any
<a class="reference internal" href="#section-spkg-check"><em>Self-Tests</em></a>, run:</p>
<div class="highlight-python"><pre>[user@localhost]$ SAGE_CHECK=yes sage -f package_name</pre>
</div>
</div>
<div class="section" id="license-information">
<h2>License information<a class="headerlink" href="#license-information" title="Permalink to this headline">¶</a></h2>
<p>If you are patching a standard Sage spkg, then you should make sure
that the license information for that package is up-to-date, both in
its <tt class="docutils literal"><span class="pre">SPKG.txt</span></tt> file and in the file <tt class="docutils literal"><span class="pre">SAGE_ROOT/COPYING.txt</span></tt>.  For
example, if you are producing an spkg which upgrades the vanilla
source to a new version, check whether the license changed between
versions.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h3><a href="index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference internal" href="#">Packaging Third-Party Code</a><ul>
<li><a class="reference internal" href="#inclusion-procedure-for-new-packages">Inclusion Procedure for New Packages</a></li>
<li><a class="reference internal" href="#directory-structure">Directory Structure</a><ul>
<li><a class="reference internal" href="#install-script">Install Script</a></li>
<li><a class="reference internal" href="#self-tests">Self-Tests</a></li>
<li><a class="reference internal" href="#package-versioning">Package Versioning</a></li>
<li><a class="reference internal" href="#the-spkg-txt-file">The SPKG.txt File</a></li>
<li><a class="reference internal" href="#patching-sources">Patching Sources</a></li>
<li><a class="reference internal" href="#modified-tarballs">Modified Tarballs</a></li>
<li><a class="reference internal" href="#checksums">Checksums</a></li>
</ul>
</li>
<li><a class="reference internal" href="#testing">Testing</a></li>
<li><a class="reference internal" href="#license-information">License information</a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="coding_in_other.html"
                                  title="previous chapter">Using External Libraries and Interfaces</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="packaging_old_spkgs.html"
                                  title="next chapter">Packaging Old-Style SPKGs</a></p>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="_sources/packaging.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="search.html" method="get">
                <input type="text" name="q" size="18" />
                <!-- The shading of the "Go" button should be consistent -->
                <!-- with the colour of the header and footer. See the file -->
                <!-- doc/common/themes/sage/theme.conf for colours used by -->
                <!-- the Sage theme. -->
                <input type="submit" style="background-color: #B8B9F6" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="packaging_old_spkgs.html" title="Packaging Old-Style SPKGs"
             >next</a> |</li>
        <li class="right" >
          <a href="coding_in_other.html" title="Using External Libraries and Interfaces"
             >previous</a> |</li>
  
    
      <a href="../index.html"><img src="_static/sagelogo.png" style="vertical-align: middle" title="Sage Logo"></a>
    
  
  
        <li><a href="index.html">Developer&#39;s Guide v1.0</a> &raquo;</li>
 
      </ul>
    </div>
    
    <div class="footer">
        &copy; Copyright 2013, The Sage Development Team.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
    <script type="text/javascript">
/*global jQuery, window */
/* Sphinx sidebar toggle.  Putting this code at the end of the body
 * enables the toggle for the live, static, and offline docs.  Note:
 * sage.misc.html.math_parse() eats jQuery's dollar-sign shortcut. */
var jq = jQuery;  
jq(document).ready(function () {
    var bar, bod, bg, fg, key, tog, wid_old, wid_new, resize, get_state, set_state;
    bod = jq('div.bodywrapper');
    bar = jq('div.sphinxsidebar');
    tog = jq('<div class="sphinxsidebartoggle"></div>');
    
    /* Delayed resize helper.  Not perfect but good enough. */
    resize = function () {
        setTimeout(function () {
            tog.height(bod.height());
        }, 100);
    };
    jq(window).resize(function () {
        resize();
    });
    
    /* Setup and add the toggle. See Sphinx v0.5.1 default.css. */
    fg = jq('div.sphinxsidebar p a').css('color') || 'rgb(152, 219, 204)';
    bg = jq('div.document').css('background-color') || 'rgb(28, 78, 99)';
    wid_old = '230px';
    wid_new = '5px';
    tog.css('background-color', bg)
        .css('border-width', '0px')
        .css('border-right', wid_new + ' ridge ' + bg)
        .css('cursor', 'pointer')
        .css('position', 'absolute')
        .css('left', '-' + wid_new)
        .css('top', '0px')
        .css('width', wid_new);
    bod.css('position', 'relative');
    bod.prepend(tog);
    resize();
    
    /* Cookie helpers. */
    key = 'sphinxsidebar=';
    set_state = function (s) {
        var date = new Date();
        /* Expiry in 7 days. */
        date.setTime(date.getTime() + (7 * 24 * 3600 * 1000));
        document.cookie = key + encodeURIComponent(s) + '; expires=' +
            date.toUTCString() + '; path=/';
    };
    get_state = function () {
        var i, c, crumbs = document.cookie.split(';');
        for (i = 0; i < crumbs.length; i += 1) {
            c = crumbs[i].replace(/^\s+/, '');
            if (c.indexOf(key) === 0) {
                return decodeURIComponent(c.substring(key.length, c.length));
            }
        }
        return null;
    };
    
    /* Event handlers. */
    tog.mouseover(function (ev) {
        tog.css('border-right-color', fg);
    }).mouseout(function (ev) {
        tog.css('border-right-color', bg);
    }).click(function (ev) {
        if (bod.hasClass('wide')) {
            bod.removeClass('wide');
            bod.css('margin-left', wid_old);
            bar.css('width', wid_old);
            bar.show();
            set_state('visible');
        } else {
            set_state('hidden');
            bar.hide();
            bar.css('width', '0px');
            bod.css('margin-left', wid_new);
            bod.addClass('wide');
        }
        resize();
    });
    
    /* Hide the normally visible sidebar? */
    if (get_state() === 'hidden') {
        tog.trigger('click');
    } else {
        set_state('visible');
    }
});
    </script>
  </body>
</html>