
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Coding in Python for Sage &mdash; Sage Developer&#39;s Guide v6.0</title>
    
    <link rel="stylesheet" href="_static/sage.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '6.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="top" title="Sage Developer&#39;s Guide v6.0" href="index.html" />
    <link rel="up" title="Writing Code for Sage" href="writing_code.html" />
    <link rel="next" title="Coding in Cython" href="coding_in_cython.html" />
    <link rel="prev" title="Conventions for Coding in Sage" href="conventions.html" />
    <link rel="icon" href="_static/sageicon.png" type="image/x-icon" />

  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="coding_in_cython.html" title="Coding in Cython"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="conventions.html" title="Conventions for Coding in Sage"
             accesskey="P">previous</a> |</li>
  
    
      <a href="../index.html"><img src="_static/sagelogo.png" style="vertical-align: middle" title="Sage Logo"></a>
    
  
  
        <li><a href="index.html">Developer&#39;s Guide v6.0</a> &raquo;</li>

          <li><a href="writing_code.html" accesskey="U">Writing Code for Sage</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="coding-in-python-for-sage">
<span id="chapter-python"></span><h1>Coding in Python for Sage<a class="headerlink" href="#coding-in-python-for-sage" title="Permalink to this headline">¶</a></h1>
<p>This chapter discusses some issues with, and advice for, coding in
Sage.</p>
<div class="section" id="design">
<h2>Design<a class="headerlink" href="#design" title="Permalink to this headline">¶</a></h2>
<p>If you are planning to develop some new code for Sage, design is
important. So think about what your program will do and how that fits
into the structure of Sage. In particular, much of Sage is implemented
in the object-oriented language Python, and there is a hierarchy of
classes that organize code and functionality. For example, if you
implement elements of a ring, your class should derive from
<tt class="docutils literal"><span class="pre">sage.structure.element.RingElement</span></tt>, rather than starting from
scratch. Try to figure out how your code should fit in with other Sage
code, and design it accordingly.</p>
</div>
<div class="section" id="special-sage-functions">
<h2>Special Sage functions<a class="headerlink" href="#special-sage-functions" title="Permalink to this headline">¶</a></h2>
<p>Functions with leading and trailing double underscores <tt class="docutils literal"><span class="pre">__XXX__</span></tt> are
all predefined by Python. Functions with leading and trailing single
underscores <tt class="docutils literal"><span class="pre">_XXX_</span></tt> are defined for Sage. Functions with a single
leading underscore are meant to be semi-private, and those with a
double leading underscore are considered really private. Users can
create functions with leading and trailing underscores.</p>
<p>Just as Python has many standard special methods for objects, Sage
also has special methods. They are typically of the form
<tt class="docutils literal"><span class="pre">_XXX_</span></tt>. (In a few cases, the trailing underscore is not included,
but this will be changed so that the trailing underscore is always
included.) This section describes these special methods.</p>
<p>All objects in Sage should derive from the Cython extension class
<tt class="docutils literal"><span class="pre">SageObject</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">sage.ext.sage_object</span> <span class="kn">import</span> <span class="n">SageObject</span>

<span class="k">class</span> <span class="nc">MyClass</span><span class="p">(</span><span class="n">SageObject</span><span class="p">,</span><span class="o">...</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>or from some other already existing Sage class:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">sage.rings.ring</span> <span class="kn">import</span> <span class="n">Algebra</span>

<span class="k">class</span> <span class="nc">MyFavoriteAlgebra</span><span class="p">(</span><span class="n">Algebra</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>You should implement the <tt class="docutils literal"><span class="pre">_latex_</span></tt> and <tt class="docutils literal"><span class="pre">_repr_</span></tt> method for every
object. The other methods depend on the nature of the object.</p>
<div class="section" id="latex-representation">
<h3>LaTeX representation<a class="headerlink" href="#latex-representation" title="Permalink to this headline">¶</a></h3>
<p>Every object <tt class="docutils literal"><span class="pre">x</span></tt> in Sage should support the command <tt class="docutils literal"><span class="pre">latex(x)</span></tt>, so
that any Sage object can be easily and accurately displayed via
LaTeX. Here is how to make a class (and therefore its instances)
support the command <tt class="docutils literal"><span class="pre">latex</span></tt>.</p>
<ol class="arabic simple">
<li>Define a method <tt class="docutils literal"><span class="pre">_latex_(self)</span></tt> that returns a LaTeX
representation of your object. It should be something that can be
typeset correctly within math mode. Do not include opening and
closing $&#8217;s.</li>
<li>Often objects are built up out of other Sage objects, and these
components should be typeset using the <tt class="docutils literal"><span class="pre">latex</span></tt> function. For
example, if <tt class="docutils literal"><span class="pre">c</span></tt> is a coefficient of your object, and you want to
typeset <tt class="docutils literal"><span class="pre">c</span></tt> using LaTeX, use <tt class="docutils literal"><span class="pre">latex(c)</span></tt> instead of
<tt class="docutils literal"><span class="pre">c._latex_()</span></tt>, since <tt class="docutils literal"><span class="pre">c</span></tt> might not have a <tt class="docutils literal"><span class="pre">_latex_</span></tt> method,
and <tt class="docutils literal"><span class="pre">latex(c)</span></tt> knows how to deal with this.</li>
<li>Do not forget to include a docstring and an example that
illustrates LaTeX generation for your object.</li>
<li>You can use any macros included in <tt class="docutils literal"><span class="pre">amsmath</span></tt>, <tt class="docutils literal"><span class="pre">amssymb</span></tt>, or
<tt class="docutils literal"><span class="pre">amsfonts</span></tt>, or the ones defined in
<tt class="docutils literal"><span class="pre">SAGE_ROOT/doc/commontex/macros.tex</span></tt>.</li>
</ol>
<p>An example template for a <tt class="docutils literal"><span class="pre">_latex_</span></tt> method follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">X</span><span class="p">:</span>
   <span class="o">...</span>
   <span class="k">def</span> <span class="nf">_latex_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
       <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">       Return the LaTeX representation of X.</span>

<span class="sd">       EXAMPLES::</span>

<span class="sd">           sage: a = X(1,2)</span>
<span class="sd">           sage: latex(a)</span>
<span class="sd">           &#39;\\frac{1}{2}&#39;</span>
<span class="sd">       &quot;&quot;&quot;</span>
       <span class="k">return</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">frac{</span><span class="si">%s</span><span class="s">}{</span><span class="si">%s</span><span class="s">}&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">latex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numer</span><span class="p">),</span> <span class="n">latex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">denom</span><span class="p">))</span>
</pre></div>
</div>
<p>As shown in the example, <tt class="docutils literal"><span class="pre">latex(a)</span></tt> will produce LaTeX code
representing the object <tt class="docutils literal"><span class="pre">a</span></tt>. Calling <tt class="docutils literal"><span class="pre">view(a)</span></tt> will display the
typeset version of this.</p>
</div>
<div class="section" id="print-representation">
<h3>Print representation<a class="headerlink" href="#print-representation" title="Permalink to this headline">¶</a></h3>
<p>The standard Python printing method is <tt class="docutils literal"><span class="pre">__repr__(self)</span></tt>. In Sage,
that is for objects that derive from <tt class="docutils literal"><span class="pre">SageObject</span></tt> (which is
everything in Sage), instead define <tt class="docutils literal"><span class="pre">_repr_(self)</span></tt>. This is
preferable because if you only define <tt class="docutils literal"><span class="pre">_repr_(self)</span></tt> and not
<tt class="docutils literal"><span class="pre">__repr__(self)</span></tt>, then users can rename your object to print however
they like. Also, some objects should print differently depending on
the context.</p>
<p>Here is an example of the <tt class="docutils literal"><span class="pre">_latex_</span></tt> and <tt class="docutils literal"><span class="pre">_repr_</span></tt> functions for the
<tt class="docutils literal"><span class="pre">Pi</span></tt> class. It is from the file
<tt class="docutils literal"><span class="pre">SAGE_ROOT/devel/sage/sage/functions/constants.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Pi</span><span class="p">(</span><span class="n">Constant</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The ratio of a circle&#39;s circumference to its diameter.</span>

<span class="sd">    EXAMPLES::</span>

<span class="sd">        sage: pi</span>
<span class="sd">        pi</span>
<span class="sd">        sage: float(pi) # rel tol 1e-10</span>
<span class="sd">        3.1415926535897931</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="o">...</span>
    <span class="k">def</span> <span class="nf">_repr_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;pi&quot;</span>

    <span class="k">def</span> <span class="nf">_latex_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;</span><span class="se">\\</span><span class="s">pi&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="matrix-or-vector-from-object">
<h3>Matrix or vector from object<a class="headerlink" href="#matrix-or-vector-from-object" title="Permalink to this headline">¶</a></h3>
<p>Provide a <tt class="docutils literal"><span class="pre">_matrix_</span></tt> method for an object that can be coerced to a
matrix over a ring <span class="math">\(R\)</span>. Then the Sage function <tt class="docutils literal"><span class="pre">matrix</span></tt> will work
for this object.</p>
<p>The following is from
<tt class="docutils literal"><span class="pre">SAGE_ROOT/devel/sage/sage/graphs/graph.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">GenericGraph</span><span class="p">(</span><span class="n">SageObject</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="k">def</span> <span class="nf">_matrix_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">R</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">am</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">am</span><span class="p">()</span><span class="o">.</span><span class="n">change_ring</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">adjacency_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">boundary_first</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>Similarly, provide a <tt class="docutils literal"><span class="pre">_vector_</span></tt> method for an object that can be
coerced to a vector over a ring <span class="math">\(R\)</span>. Then the Sage function <tt class="docutils literal"><span class="pre">vector</span></tt>
will work for this object.</p>
<p>The following is from the file
<tt class="docutils literal"><span class="pre">SAGE_ROOT/sage/sage/modules/free_module_element.pyx</span></tt>:</p>
<div class="highlight-python"><pre>cdef class FreeModuleElement(element_Vector):   # abstract base class
    ...
    def _vector_(self, R):
        return self.change_ring(R)</pre>
</div>
</div>
</div>
<div class="section" id="sage-preparsing">
<span id="section-preparsing"></span><h2>Sage preparsing<a class="headerlink" href="#sage-preparsing" title="Permalink to this headline">¶</a></h2>
<p>The following files are relevant to preparsing in Sage:</p>
<ol class="arabic simple">
<li><tt class="docutils literal"><span class="pre">SAGE_ROOT/spkg/bin/sage</span></tt></li>
<li><tt class="docutils literal"><span class="pre">SAGE_ROOT/local/bin/sage-preparse</span></tt></li>
<li><tt class="docutils literal"><span class="pre">SAGE_ROOT/devel/sage/sage/misc/preparser.py</span></tt></li>
</ol>
<p>In particular, the file <tt class="docutils literal"><span class="pre">preparser.py</span></tt> contains the Sage preparser
code. The following are some notes from it:</p>
<ul>
<li><p class="first">In Sage, methods can be called on integer and real literals. Note
that in pure Python this would be a syntax error. For example:</p>
<div class="highlight-python"><pre>sage: 16.sqrt()
4
sage: 87.factor()
3 * 29</pre>
</div>
</li>
<li><p class="first">Raw literals are not preparsed, which can be useful from an
efficiency point of view. Just like Python ints are denoted by an
L, in Sage raw integer and floating literals are followed by an &#8220;r&#8221;
(or &#8220;R&#8221;) for raw, meaning not preparsed. For example:</p>
<div class="highlight-python"><pre>sage: a = 393939r
sage: a
393939
sage: type(a)
&lt;type 'int'&gt;
sage: b = 393939
sage: type(b)
&lt;type 'sage.rings.integer.Integer'&gt;
sage: a == b
True</pre>
</div>
</li>
<li><p class="first">Raw literals can be very useful in certain cases. For instance,
Python integers can be more efficient than Sage integers when they
are very small.  Large Sage integers are much more efficient than
Python integers since they are implemented using the GMP C
library.</p>
</li>
</ul>
<p>Consult the file <tt class="docutils literal"><span class="pre">preparser.py</span></tt> for more details about Sage
preparsing, more examples involving raw literals, etc.</p>
<p>When a file <tt class="docutils literal"><span class="pre">foo.sage</span></tt> is loaded in a Sage session, a preparsed
version of <tt class="docutils literal"><span class="pre">foo.sage</span></tt> is created and named <tt class="docutils literal"><span class="pre">foo.py</span></tt>. The beginning
of <tt class="docutils literal"><span class="pre">foo.py</span></tt> states:</p>
<div class="highlight-python"><pre>This file was *autogenerated* from the file foo.sage.</pre>
</div>
</div>
<div class="section" id="the-sage-coercion-model">
<h2>The Sage coercion model<a class="headerlink" href="#the-sage-coercion-model" title="Permalink to this headline">¶</a></h2>
<p>The primary goal of coercion is to be able to transparently do
arithmetic, comparisons, etc. between elements of distinct sets. For
example, when one writes <span class="math">\(1 + 1/2\)</span>, one wants to perform arithmetic on
the operands as rational numbers, despite the left term being an
integer.  This makes sense given the obvious and natural inclusion of
the integers into the rational numbers. The goal of the coercion
system is to facilitate this (and more complicated arithmetic) without
having to explicitly map everything over into the same domain, and at
the same time being strict enough to not resolve ambiguity or accept
nonsense.</p>
<p>The coercion model for Sage is described in detail, with examples, in
the Coercion section of the Sage Reference Manual.</p>
</div>
<div class="section" id="mutability">
<h2>Mutability<a class="headerlink" href="#mutability" title="Permalink to this headline">¶</a></h2>
<p>Parent structures (e.g. rings, fields, matrix spaces, etc.) should be
immutable and globally unique whenever possible. Immutability means,
among other things, that properties like generator labels and default
coercion precision cannot be changed.</p>
<p>Global uniqueness while not wasting memory is best implemented using
the standard Python weakref module, a factory function, and module
scope variable.</p>
<p>Certain objects, e.g. matrices, may start out mutable and become
immutable later. See the file
<tt class="docutils literal"><span class="pre">SAGE_ROOT/devel/sage/sage/structure/mutability.py</span></tt>.</p>
</div>
<div class="section" id="the-hash-special-method">
<h2>The  __hash__ special method<a class="headerlink" href="#the-hash-special-method" title="Permalink to this headline">¶</a></h2>
<p>Here is the definition of <tt class="docutils literal"><span class="pre">__hash__</span></tt> from the Python reference
manual.</p>
<blockquote>
<div>Called by built-in function <tt class="docutils literal"><span class="pre">hash()</span></tt> and for operations on members of
hashed collections including set, frozenset, and dict. <tt class="docutils literal"><span class="pre">__hash__()</span></tt>
should return an integer. The only required property is that objects which
compare equal have the same hash value; it is advised to somehow mix
together (e.g. using exclusive or) the hash values for the components of
the object that also play a part in comparison of objects. If a class does
not define a
<tt class="docutils literal"><span class="pre">__cmp__()</span></tt> method it should not define a
<tt class="docutils literal"><span class="pre">__hash__()</span></tt> operation either; if it defines
<tt class="docutils literal"><span class="pre">__cmp__()</span></tt> or <tt class="docutils literal"><span class="pre">__eq__()</span></tt> but not
<tt class="docutils literal"><span class="pre">__hash__()</span></tt>, its instances will not be usable as
dictionary keys. If a class defines mutable objects and implements
a <tt class="docutils literal"><span class="pre">__cmp__()</span></tt> or <tt class="docutils literal"><span class="pre">__eq__()</span></tt> method, it
should not implement <tt class="docutils literal"><span class="pre">__hash__()</span></tt>, since the dictionary
implementation requires that a key&#8217;s hash value is immutable (if
the object&#8217;s hash value changes, it will be in the wrong hash
bucket).</div></blockquote>
<p>Notice the phrase, &#8220;The only required property is that objects which
compare equal have the same hash value.&#8221; This is an assumption made by
the Python language, which in Sage we simply cannot make (!), and
violating it has consequences. Fortunately, the consequences are
pretty clearly defined and reasonably easy to understand, so if you
know about them they do not cause you trouble. The following example
illustrates them pretty well:</p>
<div class="highlight-python"><pre>sage: v = [Mod(2,7)]
sage: 9 in v
True
sage: v = set([Mod(2,7)])
sage: 9 in v
False
sage: 2 in v
True
sage: w = {Mod(2,7):'a'}
sage: w[2]
'a'
sage: w[9]
Traceback (most recent call last):
...
KeyError: 9</pre>
</div>
<p>Here is another example:</p>
<div class="highlight-python"><pre>sage: R = RealField(10000)
sage: a = R(1) + R(10)^-100
sage: a == RDF(1)  # because the a gets coerced down to RDF
True</pre>
</div>
<p>but <tt class="docutils literal"><span class="pre">hash(a)</span></tt> should not equal <tt class="docutils literal"><span class="pre">hash(1)</span></tt>.</p>
<p>Unfortunately, in Sage we simply cannot require</p>
<div class="highlight-python"><pre>(#)   "a == b ==&gt; hash(a) == hash(b)"</pre>
</div>
<p>because serious mathematics is simply too complicated for this
rule. For example, the equalities <tt class="docutils literal"><span class="pre">z</span> <span class="pre">==</span> <span class="pre">Mod(z,</span> <span class="pre">2)</span></tt> and
<tt class="docutils literal"><span class="pre">z</span> <span class="pre">==</span> <span class="pre">Mod(z,</span> <span class="pre">3)</span></tt> would force <tt class="docutils literal"><span class="pre">hash()</span></tt> to be constant on the
integers.</p>
<p>The only way we could &#8220;fix&#8221; this problem for good would be to abandon
using the <tt class="docutils literal"><span class="pre">==</span></tt> operator for &#8220;Sage equality&#8221;, and implement Sage
equality as a new method attached to each object. Then we could follow
Python rules for <tt class="docutils literal"><span class="pre">==</span></tt> and our rules for everything else, and all
Sage code would become completely unreadable (and for that matter
unwritable). So we just have to live with it.</p>
<p>So what is done in Sage is to attempt to satisfy <tt class="docutils literal"><span class="pre">(#)</span></tt> when it is
reasonably easy to do so, but use judgment and not go overboard.
For example,</p>
<div class="highlight-python"><pre>sage: hash(Mod(2,7))
2</pre>
</div>
<p>The output 2 is better than some random hash that also involves the
moduli, but it is of course not right from the Python point of view,
since <tt class="docutils literal"><span class="pre">9</span> <span class="pre">==</span> <span class="pre">Mod(2,7)</span></tt>.</p>
<p>The goal is to make a hash function that is fast, but within reason
respects any obvious natural inclusions and coercions.</p>
</div>
<div class="section" id="exceptions">
<h2>Exceptions<a class="headerlink" href="#exceptions" title="Permalink to this headline">¶</a></h2>
<p>Please avoid code like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">try</span><span class="p">:</span>
    <span class="n">some_code</span><span class="p">()</span>
<span class="k">except</span><span class="p">:</span>               <span class="c"># bad</span>
    <span class="n">more_code</span><span class="p">()</span>
</pre></div>
</div>
<p>Instead, catch specific exceptions. For example,</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">try</span><span class="p">:</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__coordinate_ring</span>
<span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="n">OtherExceptions</span><span class="p">)</span> <span class="k">as</span> <span class="n">msg</span><span class="p">:</span>           <span class="c"># Good</span>
    <span class="n">more_code_to_compute_something</span><span class="p">()</span>
</pre></div>
</div>
<p>Note that the syntax in <tt class="docutils literal"><span class="pre">except</span></tt> is to list all the exceptions that
are caught as a tuple, followed by an error message.</p>
<p>If you do not have any exceptions explicitly listed (as a tuple), your
code will catch absolutely anything, including <tt class="docutils literal"><span class="pre">ctrl-C</span></tt>, typos in
the code, and alarms, and this will lead to confusion. Also, this
might catch real errors which should be propagated to the user.</p>
</div>
<div class="section" id="importing">
<h2>Importing<a class="headerlink" href="#importing" title="Permalink to this headline">¶</a></h2>
<p>We mention two issues with importing: circular imports and importing
large third-party modules.</p>
<p>First, you must avoid circular imports. For example, suppose that
the file
<tt class="docutils literal"><span class="pre">SAGE_ROOT/devel/sage/sage/algebras/steenrod_algebra.py</span></tt>
started with a line</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">sage.sage.algebras.steenrod_algebra_bases</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
<p>and that the file
<tt class="docutils literal"><span class="pre">SAGE_ROOT/devel/sage/sage/algebras/steenrod_algebra_bases.py</span></tt>
started with a line</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">sage.sage.algebras.steenrod_algebra</span> <span class="kn">import</span> <span class="n">SteenrodAlgebra</span>
</pre></div>
</div>
<p>This sets up a loop: loading one of these files requires the other,
which then requires the first, etc.</p>
<p>With this set-up, running Sage will produce an error:</p>
<div class="highlight-python"><pre>Exception exceptions.ImportError: 'cannot import name SteenrodAlgebra'
in 'sage.rings.polynomial.polynomial_element.
Polynomial_generic_dense.__normalize' ignored
-------------------------------------------------------------------
ImportError                       Traceback (most recent call last)

...
ImportError: cannot import name SteenrodAlgebra</pre>
</div>
<p>Instead, you might replace the <tt class="docutils literal"><span class="pre">import</span> <span class="pre">*</span></tt> line at the top of the
file by more specific imports where they are needed in the code. For
example, the <tt class="docutils literal"><span class="pre">basis</span></tt> method for the class <tt class="docutils literal"><span class="pre">SteenrodAlgebra</span></tt> might
look like this (omitting the documentation string):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">basis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">steenrod_algebra_bases</span> <span class="kn">import</span> <span class="n">steenrod_algebra_basis</span>
    <span class="k">return</span> <span class="n">steenrod_algebra_basis</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_basis_name</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prime</span><span class="p">)</span>
</pre></div>
</div>
<p>Second, do not import at the top level of your module a third-party
module that will take a long time to initialize (e.g. matplotlib). As
above, you might instead import specific components of the module when
they are needed, rather than at the top level of your file.</p>
<p>It is important to try to make <tt class="docutils literal"><span class="pre">from</span> <span class="pre">sage.all</span> <span class="pre">import</span> <span class="pre">*</span></tt> as fast as
possible, since this is what dominates the Sage startup time, and
controlling the top-level imports helps to do this.</p>
</div>
<div class="section" id="deprecation">
<h2>Deprecation<a class="headerlink" href="#deprecation" title="Permalink to this headline">¶</a></h2>
<p>Sooner or later you will find places in the Sage library that are, in
hindsight, not designed as well as they could be. Of course you want
to improve the overall state, but at the same time we don&#8217;t want to
pull out the carpet under our users&#8217; feet. The process of removing old
code is called deprecation.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Before removing any functionality, you should keep a deprecation
warning in place for at least one year (if possible). The
deprecation must include the trac ticket number where it was
introduced.</p>
</div>
<p>For example, let&#8217;s say you run across the following while working on a
module in the Sage library:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">SageObject</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">terrible_idea</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">def</span> <span class="nf">bad_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weird_keyword</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span>
</pre></div>
</div>
<p>You note that the <tt class="docutils literal"><span class="pre">terrible_idea()</span></tt> method does not make any sense,
and should be removed altogether. You open the trac ticket number 3333
(say), and replace the code with:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">terrible_idea</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">sage.misc.superseded</span> <span class="kn">import</span> <span class="n">deprecation</span>
    <span class="n">deprecation</span><span class="p">(</span><span class="mi">3333</span><span class="p">,</span> <span class="s">&#39;You can just call f() instead&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">1</span>
</pre></div>
</div>
<p>Later, you come up with a much better name for the second method. You
open the trac ticket number 4444, and replace it with:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">much_better_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">1</span>

<span class="n">bad_name</span> <span class="o">=</span> <span class="n">deprecated_function_alias</span><span class="p">(</span><span class="mi">4444</span><span class="p">,</span> <span class="n">much_better_name</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, you like the <tt class="docutils literal"><span class="pre">f()</span></tt> method name but you don&#8217;t like the
<tt class="docutils literal"><span class="pre">weird_keyword</span></tt> name. You fix this by opening the trac ticket 5555,
and replacing it with:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@rename_keyword</span><span class="p">(</span><span class="n">deprecation</span><span class="o">=</span><span class="mi">5555</span><span class="p">,</span> <span class="n">weird_keyword</span><span class="o">=</span><span class="s">&#39;nice_keyword&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nice_keyword</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">1</span>
</pre></div>
</div>
<p>Now, any user that still relies on the deprecated functionality will
be informed that this is about to change, yet the deprecated commands
still work. With all necessary imports, the final result looks like
this:</p>
<div class="highlight-python"><pre>sage: from sage.misc.superseded import deprecation, deprecated_function_alias
sage: from sage.misc.decorators import rename_keyword

sage: class Foo(SageObject):
...
...     def terrible_idea(self):
...         deprecation(3333, 'You can just call f() instead')
...         return 1
...
...     def much_better_name(self):
...         return 1
...
...     bad_name = deprecated_function_alias(4444, much_better_name)
...
...     @rename_keyword(deprecation=5555, weird_keyword='nice_keyword')
...     def f(self, nice_keyword=True):
...         return 1

sage: foo = Foo()
sage: foo.terrible_idea()
doctest:...: DeprecationWarning: You can just call f() instead
See http://trac.sagemath.org/3333 for details.
1

sage: foo.bad_name()
doctest:...: DeprecationWarning: bad_name is deprecated. Please use much_better_name instead.
See http://trac.sagemath.org/4444 for details.
1

sage: foo.f(weird_keyword=False)
doctest:...: DeprecationWarning: use the option 'nice_keyword' instead of 'weird_keyword'
See http://trac.sagemath.org/5555 for details.
1</pre>
</div>
</div>
<div class="section" id="editing-existing-files">
<h2>Editing existing files<a class="headerlink" href="#editing-existing-files" title="Permalink to this headline">¶</a></h2>
<p>There are several copies of Sage library files, and it can be
confusing for beginners to know which one to modify.  In the directory
<tt class="docutils literal"><span class="pre">SAGE_ROOT/devel/sage</span></tt>, there is a subdirectory <tt class="docutils literal"><span class="pre">build</span></tt> which
contains copies of Python files and their byte-compiled versions,
along with compiled version of Cython files.  These are the files that
Sage actually uses, but <em>you</em> <em>never</em> <em>need</em> <em>to</em> <em>touch</em> <em>these</em>.
Instead, always work with files in the directory
<tt class="docutils literal"><span class="pre">SAGE_ROOT/devel/sage/sage</span></tt>.  For example, if you want to add a new
method for simplicial complexes, then edit the file
<tt class="docutils literal"><span class="pre">SAGE_ROOT/devel/sage/sage/homology/simplicial_complex.py</span></tt>.  Save
your changes, and then type <tt class="docutils literal"><span class="pre">sage</span> <span class="pre">-b</span></tt> to incorporate those changes.
This automatically copies the appropriate files into the appropriate
places under <tt class="docutils literal"><span class="pre">SAGE_ROOT/devel/sage/build</span></tt>.</p>
<p>You should also read <a class="reference internal" href="producing_patches.html#chapter-mercurial"><em>Producing Patches with Mercurial</em></a> for information about
how to create a copy of the Sage library and make your changes there,
so that first, it is easy to undo your changes, and second, it is easy
to produce a &#8220;patch&#8221; file so you can share your changes with other
people.</p>
</div>
<div class="section" id="creating-a-new-directory">
<h2>Creating a new directory<a class="headerlink" href="#creating-a-new-directory" title="Permalink to this headline">¶</a></h2>
<p>If you want to create a new directory in the Sage library
<tt class="docutils literal"><span class="pre">SAGE_ROOT/devel/sage/sage</span></tt> (say, <tt class="docutils literal"><span class="pre">measure_theory</span></tt>), that directory
should contain an empty file <tt class="docutils literal"><span class="pre">__init__.py</span></tt> in addition to whatever
files you want to add (say, <tt class="docutils literal"><span class="pre">borel_measure.py</span></tt> and
<tt class="docutils literal"><span class="pre">banach_tarski.py</span></tt>), and also a file <tt class="docutils literal"><span class="pre">all.py</span></tt> listing imports from
that directory.  The file <tt class="docutils literal"><span class="pre">all.py</span></tt> might look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">borel_measure</span> <span class="kn">import</span> <span class="n">BorelMeasure</span>

<span class="kn">from</span> <span class="nn">banach_tarski</span> <span class="kn">import</span> <span class="n">BanachTarskiParadox</span>
</pre></div>
</div>
<p>Then in the file <tt class="docutils literal"><span class="pre">SAGE_ROOT/devel/sage/sage/all.py</span></tt>, add a line</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">sage.measure_theory.all</span>  <span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
<p>Finally, add the directory name (&#8220;measure_theory&#8221;) to the <tt class="docutils literal"><span class="pre">packages</span></tt>
list in the Distutils section of the file
<tt class="docutils literal"><span class="pre">SAGE_ROOT/devel/sage/setup.py</span></tt>: add a line</p>
<div class="highlight-python"><div class="highlight"><pre><span class="s">&#39;sage.measure_theory&#39;</span><span class="p">,</span>
</pre></div>
</div>
<p>between</p>
<div class="highlight-python"><div class="highlight"><pre><span class="s">&#39;sage.matrix&#39;</span><span class="p">,</span>
</pre></div>
</div>
<p>and</p>
<div class="highlight-python"><div class="highlight"><pre><span class="s">&#39;sage.media&#39;</span><span class="p">,</span>
</pre></div>
</div>
<p>As noted above, you should also read <a class="reference internal" href="producing_patches.html#chapter-mercurial"><em>Producing Patches with Mercurial</em></a> for
information about how to do this in a copy of the Sage library and how
to disseminate your changes.</p>
</div>
<div class="section" id="using-optional-packages">
<h2>Using optional packages<a class="headerlink" href="#using-optional-packages" title="Permalink to this headline">¶</a></h2>
<p>If a function requires an optional package, that function should fail
gracefully&#8212;perhaps using a <tt class="docutils literal"><span class="pre">try</span></tt>-<tt class="docutils literal"><span class="pre">except</span></tt> block&#8212;when the
optional package is not available, and should give a hint about how to
install it. For example, typing <tt class="docutils literal"><span class="pre">sage</span> <span class="pre">-optional</span></tt> gives a list of all
optional packages, so it might suggest to the user that they type
that. The command <tt class="docutils literal"><span class="pre">optional_packages()</span></tt> from within Sage also
returns this list.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h3><a href="index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference internal" href="#">Coding in Python for Sage</a><ul>
<li><a class="reference internal" href="#design">Design</a></li>
<li><a class="reference internal" href="#special-sage-functions">Special Sage functions</a><ul>
<li><a class="reference internal" href="#latex-representation">LaTeX representation</a></li>
<li><a class="reference internal" href="#print-representation">Print representation</a></li>
<li><a class="reference internal" href="#matrix-or-vector-from-object">Matrix or vector from object</a></li>
</ul>
</li>
<li><a class="reference internal" href="#sage-preparsing">Sage preparsing</a></li>
<li><a class="reference internal" href="#the-sage-coercion-model">The Sage coercion model</a></li>
<li><a class="reference internal" href="#mutability">Mutability</a></li>
<li><a class="reference internal" href="#the-hash-special-method">The  __hash__ special method</a></li>
<li><a class="reference internal" href="#exceptions">Exceptions</a></li>
<li><a class="reference internal" href="#importing">Importing</a></li>
<li><a class="reference internal" href="#deprecation">Deprecation</a></li>
<li><a class="reference internal" href="#editing-existing-files">Editing existing files</a></li>
<li><a class="reference internal" href="#creating-a-new-directory">Creating a new directory</a></li>
<li><a class="reference internal" href="#using-optional-packages">Using optional packages</a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="conventions.html"
                                  title="previous chapter">Conventions for Coding in Sage</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="coding_in_cython.html"
                                  title="next chapter">Coding in Cython</a></p>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="_sources/coding_in_python.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="search.html" method="get">
                <input type="text" name="q" size="18" />
                <!-- The shading of the "Go" button should be consistent -->
                <!-- with the colour of the header and footer. See the file -->
                <!-- doc/common/themes/sage/theme.conf for colours used by -->
                <!-- the Sage theme. -->
                <input type="submit" style="background-color: #B8B9F6" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="coding_in_cython.html" title="Coding in Cython"
             >next</a> |</li>
        <li class="right" >
          <a href="conventions.html" title="Conventions for Coding in Sage"
             >previous</a> |</li>
  
    
      <a href="../index.html"><img src="_static/sagelogo.png" style="vertical-align: middle" title="Sage Logo"></a>
    
  
  
        <li><a href="index.html">Developer&#39;s Guide v6.0</a> &raquo;</li>

          <li><a href="writing_code.html" >Writing Code for Sage</a> &raquo;</li> 
      </ul>
    </div>
    
    <div class="footer">
        &copy; Copyright 2005--2011, The Sage Development Team.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
    <script type="text/javascript">
/*global jQuery, window */
/* Sphinx sidebar toggle.  Putting this code at the end of the body
 * enables the toggle for the live, static, and offline docs.  Note:
 * sage.misc.html.math_parse() eats jQuery's dollar-sign shortcut. */
var jq = jQuery;  
jq(document).ready(function () {
    var bar, bod, bg, fg, key, tog, wid_old, wid_new, resize, get_state, set_state;
    bod = jq('div.bodywrapper');
    bar = jq('div.sphinxsidebar');
    tog = jq('<div class="sphinxsidebartoggle"></div>');
    
    /* Delayed resize helper.  Not perfect but good enough. */
    resize = function () {
        setTimeout(function () {
            tog.height(bod.height());
        }, 100);
    };
    jq(window).resize(function () {
        resize();
    });
    
    /* Setup and add the toggle. See Sphinx v0.5.1 default.css. */
    fg = jq('div.sphinxsidebar p a').css('color') || 'rgb(152, 219, 204)';
    bg = jq('div.document').css('background-color') || 'rgb(28, 78, 99)';
    wid_old = '230px';
    wid_new = '5px';
    tog.css('background-color', bg)
        .css('border-width', '0px')
        .css('border-right', wid_new + ' ridge ' + bg)
        .css('cursor', 'pointer')
        .css('position', 'absolute')
        .css('left', '-' + wid_new)
        .css('top', '0px')
        .css('width', wid_new);
    bod.css('position', 'relative');
    bod.prepend(tog);
    resize();
    
    /* Cookie helpers. */
    key = 'sphinxsidebar=';
    set_state = function (s) {
        var date = new Date();
        /* Expiry in 7 days. */
        date.setTime(date.getTime() + (7 * 24 * 3600 * 1000));
        document.cookie = key + encodeURIComponent(s) + '; expires=' +
            date.toUTCString() + '; path=/';
    };
    get_state = function () {
        var i, c, crumbs = document.cookie.split(';');
        for (i = 0; i < crumbs.length; i += 1) {
            c = crumbs[i].replace(/^\s+/, '');
            if (c.indexOf(key) === 0) {
                return decodeURIComponent(c.substring(key.length, c.length));
            }
        }
        return null;
    };
    
    /* Event handlers. */
    tog.mouseover(function (ev) {
        tog.css('border-right-color', fg);
    }).mouseout(function (ev) {
        tog.css('border-right-color', bg);
    }).click(function (ev) {
        if (bod.hasClass('wide')) {
            bod.removeClass('wide');
            bod.css('margin-left', wid_old);
            bar.css('width', wid_old);
            bar.show();
            set_state('visible');
        } else {
            set_state('hidden');
            bar.hide();
            bar.css('width', '0px');
            bod.css('margin-left', wid_new);
            bod.addClass('wide');
        }
        resize();
    });
    
    /* Hide the normally visible sidebar? */
    if (get_state() === 'hidden') {
        tog.trigger('click');
    } else {
        set_state('visible');
    }
});
    </script>
  </body>
</html>